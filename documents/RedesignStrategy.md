### Overarching strategy to reduce duplication, shrink modules, adopt SoA on hot paths, and sustain SIMD performance

This unifies the refactor plan with your existing docs (`DOD_ANALYSIS.md`, `documents/ARCHITECTURE_REVIEW_DOD.md`, `documents/PORTABLE_SIMD_VIABILITY.md`) into a single, actionable strategy that addresses: (1) excessive duplication in SW kernels and pipelines; (2) 1000+ line files; (3) a path toward portable SIMD without regressions; (4) migration to a Structure‑of‑Arrays (SoA) layout on kernel and pipeline hot paths to increase CPU efficiency and throughput.

### Objectives (why and how we’ll measure)
- Reduce duplicated code in SIMD SW kernels by 25–40% and pipeline code by 10–15% without behavior changes.
- Split monoliths so no source file exceeds 500 LOC (soft cap 400 LOC).
- Adopt SoA as the default memory layout on hot paths (kernels and batch pipelines), eliminating per‑call transpositions and improving cache efficiency.
- Preserve or improve performance (±2% of baseline per ISA) and correctness (no golden diffs).
- Establish sustained practices (DoD, reviews, CI checks) to prevent duplication/size/SoA regressions.

### Current status (as of 2025‑11‑30)
- Core SIMD kernel (int8) unified and adopted:
  - AVX2 path now calls the shared `sw_kernel::<32, SwEngine256>` via thin wrapper; parity tests green; no perf regressions observed.
  - SSE/NEON path now calls the shared `sw_kernel::<16, SwEngine128>`; tests green on x86_64 and aarch64; no perf regressions observed.
  - Deterministic and randomized parity tests added and kept to guard future changes.
- CI/tooling:
  - Quality workflow with rustfmt, clippy (deny warnings), and size‑guard (≤500 LOC in hot modules) is active.
  - Perf workflow runs Criterion benches and stores artifacts; problematic engine comparison bench is gated behind an opt‑in feature.
- Documentation: this strategy doc reflects the SoA‑first plan; portable‑SIMD remains exploratory.

Pending/Planned:
- AVX‑512 migration (int8, then int16) to the shared kernel — postponed until after SoA‑first work.
- SoA‑first in pipelines to remove per‑call transposes and improve throughput (next feature).

### Scope and priorities
1. Core SW alignment: `src/core/alignment/banded_swa_{sse_neon,avx2,avx512}.rs` and `banded_swa.rs`.
2. Pipelines: `src/pipelines/linear/batch_extension.rs`.
3. Memory layout: SoA‑first design across kernels and batch pipelines; remove redundant AoS↔SoA transforms.
4. SIMD abstraction: confirm viability of common kernel via `simd_abstraction` now; explore `portable-simd` per viability doc.

### Guiding principles
- Single source of truth for algorithm skeleton and pre/post-processing; thin ISA wrappers only.
- Keep public API and runtime dispatch intact; changes are internal.
- Inline only tiny helpers; keep the kernel merely `#[inline]` to avoid icache bloat.
- Incremental, low-risk PRs with perf guardrails and DoD checks.

### Target architecture and layout
- Core alignment module structure:
  - `src/core/alignment/types.rs`: `ExtensionDirection`, `OutScore`, small shared types (re-exported from `mod.rs`).
  - `src/core/alignment/banded_swa/`
    - `mod.rs`: module surface and re-exports.
    - `shared.rs`: inlineable helpers (batch pad, SoA interleave, profile build, band bounds, z-drop, result packing). SoA becomes the canonical internal layout for sequences and DP buffers.
    - `kernel.rs`: generic DP kernel parameterized by engine and lane width.
    - `isa_sse_neon.rs`, `isa_avx2.rs`, `isa_avx512.rs`: thin `#[target_feature]` wrappers generated by a macro.
    - `scalar.rs`: scalar fallback.
    - `dispatch.rs`: optional; or keep in `BandedPairWiseSW` impl.
- Pipelines/linear batch extension:
  - `src/pipelines/linear/batch_extension/`
    - `mod.rs`, `types.rs`, `collect.rs`, `convert.rs`, `dispatch.rs`, `distribute.rs`.
    - Use core’s `ExtensionDirection`; dispatch calls `BandedPairWiseSW::simd_banded_swa_dispatch{,_int16}`.
    - SoA‑first: batches maintain SoA‑interleaved sequence storage compatible with kernel lane width to avoid per‑call transposes.

#### SoA memory layout specification (hot paths)
- Sequence buffers (SoA):
  - `query_soa[pos * LANES + lane]` and `target_soa[pos * LANES + lane]` for lane‑major interleaving; positions are contiguous for better prefetch.
  - Padding to `MAX_SEQ_LEN` with sentinel byte to avoid bounds checks; align to cache line (64B) and ISA vector width.
- DP buffers (SoA):
  - H/E/F maintained as SoA vectors per position: `h[pos * LANES + lane]`, etc., enabling contiguous vector loads/stores per step.
- Query profile (SoA):
  - Precomputed per base with SoA stride per position; reused across rows.
- Pipelines batches:
  - `ExtensionJobBatch` stores SoA buffers per sub‑batch sized to the chosen SIMD width; per‑job offsets maintained as views into SoA blocks.
  - Conversions from read/chain AoS happen once at ingest time; kernels consume SoA directly.

### Technical plan (phased)
Phase 1 — Foundations and quick wins
- Create `types.rs` in core; move `ExtensionDirection` (use in pipelines). Re-export from `alignment::mod`.
- Add `banded_swa/shared.rs` with helpers: `pad_batch`, `soa_transform`, `pack_outscores`.
- Switch `banded_swa_sse_neon.rs` to use helpers (no kernel change yet).
- Split `pipelines/linear/batch_extension.rs` into `types.rs` + `collect.rs` (no logic changes).
- DoD for this phase:
  - All unit/integration tests pass.
  - File-size check ensures no file > 700 LOC in touched areas (soft start).

Phase 2 — Generic kernel + macroized wrappers
- Add trait surface for the kernel over existing `simd_abstraction` (minimal ops the DP needs).
- Implement `kernel.rs` with `sw_kernel<const W: usize, E: SwSimd>`.
- Add `generate_swa_entry!` macro; refactor `sse_neon` wrappers to call the kernel. ✓
- Mirror for AVX2. ✓
- AVX-512 (including int16 variants). (postponed)
- DoD:
  - Numerical identity: SIMD vs scalar tests and inter-ISA crosschecks green.
  - Benchmarks within ±2% vs baseline (100/150/250bp, typical bands; z-drop on).
  - File-size: each ISA file ≤ 200 LOC; kernel ≤ 350 LOC; shared ≤ 300 LOC.

Phase 2b — SoA‑first layout across kernels and pipelines (hot paths)
- Goals: remove per‑call AoS→SoA transpositions; make SoA the canonical layout end‑to‑end on hot paths.
- Scope:
  - Define and document SoA spec (above) with alignment requirements and sentinel padding.
  - Update `ExtensionJobBatch` to store sequences in SoA form per sub‑batch sized to the active SIMD width; maintain lightweight views for per‑job slices.
  - Update `shared.rs` to accept pre‑SoA inputs and no‑op when already SoA; keep a transitional path for legacy AoS callers.
  - Ensure `kernel.rs` directly consumes SoA buffers; remove redundant transposes in ISA wrappers.
  - Add fallbacks for scalar path to accept SoA without extra copies.
- DoD:
  - Zero correctness diffs on unit/integration tests.
  - Measurable reduction in per‑batch overhead (>80% drop in transform time); overall throughput +5–15% on pipeline microbenchmarks.
  - L1D miss rate reduced on representative workloads (perf counters), or equivalent throughput gain.
  - No file > 500 LOC in modified modules.

Next actions for Phase 2b (to execute next):
- Pipelines: introduce SoA storage in `ExtensionJobBatch`, plus views per job sized to active SIMD width.
- Core/shared: make `soa_transform` a no‑op when provided SoA; ensure `sw_kernel` consumes SoA directly (already true); keep scalar fallback path compatible.
- Bench/CI: add a microbench metric that records AoS→SoA transform time; perf CI should fail if transform time exceeds threshold once SoA‑first lands.

Phase 3 — Core module split and pipeline consolidation
- Split `banded_swa.rs` into `scalar.rs` and `dispatch.rs`; keep a small umbrella re-export file for compatibility.
- Replace pipeline dispatch logic with thin calls to core dispatch; unify tuple conversions via a single `convert.rs` helper.
- Move large scenario tests from source to `tests/`.
- DoD:
  - No public API change (types and method names stable or re-exported).
  - `pipelines/linear/batch_extension` files each ≤ 400 LOC.

Phase 4 — Portable SIMD exploration and optional adoption
- Per `PORTABLE_SIMD_VIABILITY.md`, prototype a portable-simd engine implementing the `SwSimd` trait behind a feature flag.
- Run A/B perf on x86 (SSE/AVX2/AVX-512) and aarch64 (NEON).
- DoD:
  - If within 0–5% of current backends, consider making portable-simd the default kernel and keep ISA wrappers as specialized fast paths where they win.
  - Otherwise, keep current abstraction and document rationale.

### Inlineable helper and macro surface (concrete)
- Helpers (all `#[inline(always)]`):
  - `pad_batch<const W: usize>(batch: &[(i32,&[u8],i32,&[u8],i32,i32)]) -> ([i8; W],[i8; W],[i8; W],[i8; W], i32, i32, [(i32,&[u8],i32,&[u8],i32,i32); W])`
  - `soa_transform<const W: usize, const MAX: usize>(padded: &[(i32,&[u8],i32,&[u8],i32,i32)]) -> (Vec<u8>, Vec<u8>)`
  - `build_profile<const W: usize>(mat: &[i8;25], m: i32, query_soa: &[u8], q_max: usize) -> SmallProfile`
  - `band_bounds(i: i32, w: i32, qlen: i32, tlen: i32) -> (i32, i32)`
  - `zdrop_check(/* current params */) -> bool`
  - `pack_outscores<const W: usize>(/* lanes, trackers */) -> Vec<OutScore>`
  - SoA helpers for pipelines: `make_batch_soa<const W: usize>(jobs: &ExtensionJobBatch) -> SoABuffers` and `soa_views_for_job(job_idx)`.
- Kernel:
  ```rust
  pub trait SwSimd { /* minimal ops used in kernel */ }
  #[inline]
  pub unsafe fn sw_kernel<const W: usize, E: SwSimd>(params: &KernelParams<'_>) -> Vec<OutScore> { /* shared DP */ }
  ```
- Macro `generate_swa_entry!` emitting per-ISA wrappers with `#[target_feature]` and constants bound.

### Performance and correctness gates (CI/DoD integration)
- Integrate DoD items from `DOD_ANALYSIS.md` and `documents/ARCHITECTURE_REVIEW_DOD.md`:
  - Mandatory: all existing tests pass; no panics under `RUSTFLAGS="-Z sanitizer=address"` on nightly in CI (optional job).
  - Perf gates: run microbenchmarks; fail PR if >±3% regression on any ISA vs last baseline. Store baselines in artifacts.
  - Lints: `clippy` + `rustfmt` + size guard (script fails on files > 500 LOC under `core/alignment/banded_swa` and `pipelines/linear/batch_extension`).
  - Doc check: module-level docs present for new modules; public types documented.
  - SoA guard: perf CI includes a pipeline microbench that must not re‑introduce per‑call transpose cost; fail if transform time exceeds threshold.

### Documentation consolidation
- Collapse the three docs into one ADR-style doc: `docs/adr/ADR-001-swa-dedup-and-module-split.md`:
  - Problem statement: duplication and oversized modules slow velocity; risks.
  - Decision: shared helpers + generic kernel + thin ISA wrappers; module split layout above.
  - Alternatives: keep copies; adopt portable-simd only; why rejected now.
  - Consequences: reduced LOC, simpler reviews, controlled inlining.
  - Rollout plan: the phased plan and DoD.
  - Link appendices: retain `PORTABLE_SIMD_VIABILITY.md` content as Appendix A; keep `DOD_ANALYSIS.md` acceptance set as Appendix B; include relevant parts of `ARCHITECTURE_REVIEW_DOD.md` as Appendix C.

### Governance and ownership
- Code ownership:
  - Core kernel and shared helpers: Core Alignment owners.
  - ISA wrappers: Platform-specific maintainers (x86/aarch64) with code review from Core.
  - Pipelines batch extension: Pipelines owners, with Core reviewer when touching dispatch.
- Review checklist (short):
  - Uses shared helpers; no copy/paste.
  - File-size limits respected.
  - Perf baseline within gate; tests and docs updated.

### Risks and mitigations
- Codegen differences from refactor: mitigate with asm inspection in one representative path (`cargo asm`) and perf gates.
- Monomorphization/code size: keep kernel generic only over width/engine; avoid over-parameterization.
- API drift: retain re-export shims until a deprecation window passes.

### Timeline (indicative)
- Week 1–2: Phase 1 PRs (types.rs, shared.rs, initial SSE helper adoption), then Phase 2 kernel + SSE/AVX2 migration. ✓
- Week 3: Start Phase 2b (SoA‑first) in pipelines (introduce SoA buffers, views, conversions at ingest). *
- Week 4: Continue Phase 2b; remove per‑call transposes in ISA wrappers when SoA is provided; defer AVX‑512 until after SoA‑first.
- Week 5: Phase 3 module split of core `banded_swa.rs` plus test relocation; pipeline dispatch consolidation.
- Week 6+: Phase 4 portable-simd prototype behind feature flag; decide adopt/park.

### Acceptance summary
- LOC reduced per targets; no file > 500 LOC in refactored areas.
- All correctness tests green; golden outputs unchanged.
- Perf within ±2% per ISA on agreed workloads; pipeline throughput +5–15% from SoA adoption with reduced per‑batch overhead.
- ADR committed; CI gates and review checklist in place.

### Status checklist (quick)
- [x] AVX2 uses shared kernel (int8), parity and perf OK.
- [x] SSE/NEON uses shared kernel (int8), parity and perf OK.
- [ ] AVX‑512 (int8, int16) migrated to shared kernel (post‑SoA).
- [ ] Pipelines SoA‑first adoption; transforms removed on hot paths.
- [ ] Core/pipelines module splits finalized; size guard enforced across new files.